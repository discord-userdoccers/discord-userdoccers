# Experiments

Experiments are a form of A/B testing used by Discord in the client- and server-side of their applications to serve
different experiences or behaviours to different users randomly and/or based on location, client version, etc.

At their core, rollouts are simply YAML inputted into the Discord admin panel, but not all of the data
is required by clients. Therefore, the actual value most clients see is obfuscated and complex to decipher.

## Fingerprints

Even the marketing website uses A/B tests to hook users into the app and therefore the app needs a unique way to identify the
person using the website without using authentication (for users initially visiting the landing page), so it resorts to using
"fingerprints".

These aren't the usual fingerprints generated by collecting information about the browser, instead they are snowflakes generated
by unauthenticated requests to [Get Experiment Rollouts](#get-experiment-rollouts). It is expected that fingerprints are sent
in the `X-Fingerprint` header in all subsequent requests to the API until authentication, in order to track A/B tests and allow
access to API-locked portions of experiments.

A fingerprint is comprised of a snowflake and a hashed cryptographic value presumably used in the backend. It looks like
this: `1084179945133187083.JQddgNMmwJPghoBtFmaH7jTmdsw`.

<!-- TODO: link to auth page on this -->

When registering a new account, the fingerprint is passed, and (if valid) is used as the created user's ID. This is done in order
to preserve experiments across to the registered user. Therefore, a user account's creation time theoretically represents the first
time they visited Discord's marketing website.

## Rollouts

Experiment rollouts are defined in _populations_ based on the user or guild's [rollout position](#rollout-positions)
and can have _filters_ to narrow each population's availability.

###### Example Rollout

```md
2023-02_stage_boosting (1816004721)

### Treatment 1

Filters

Guild Features: [COMMUNITY]
Member Count Range: 1000 - null
Hash Range: Hash Key: 1816004721, Target: 10000

Position Ranges

5000-9500, 9500-10000

### Control

Filters

Guild Features: [COMMUNITY]
Member Count Range: 1000 - null

Position Ranges

0 - 10000

### None

Position Ranges

0 - 10000
```

### Treatments

`Control` and `None` are represented in the API as the integer values `0` and `-1`, respectively. Just as a warning, there are some instances of experiments having specific unnecessary treatments
labelled as `Control` indexed as `1`.

### Rollout Positions

A rollout position is calculated using the following pseudo code, where `exp_name` is the human readable name for the experiment and `resource_id` is the user, fingerprint or guild's ID.
This position is used in conjunction with the rollout populations and filters to figure out what the assigned bucket for the experiments are by simply checking which treatment the population is included in[.](https://gist.github.com/c3f521becd84b923c2778546c79a7a03)

```py
murmurhash3.hash('exp_name:resource_id', signed=False) % 1e4
```

## Data Structures

There are two types of experiments, user experiments and guild experiments. Metadata and human-readable experiment names
are available in the user-facing clients. However, API objects do not contain such data, except for guild experiments which may have a human-readable name provided for hash calculations, overriding the one in clients.

All of the below objects are represented as arrays following the order in which the fields are displayed.

### User Experiments

User experiment data returned by the API is very limited. In contrast to the wide range of data the API provides for
guild rollouts, the only values we can programmatically retrieve from the API are the user/[fingerprint](#fingerprints)'s assigned
bucket for the experiment.

###### User Experiment Structure

| Field       | Type     | Description                                                            |
| ----------- | -------- | ---------------------------------------------------------------------- |
| hash        | integer  | 32-bit unsigned Murmur3 hash of the experiment's name                  |
| revision    | integer  | Current version of the rollout                                         |
| bucket      | integer  | The requesting user or fingerprint's assigned experiment bucket        |
| override    | integer  | Overriden bucket for the user, holds more priority than `bucket`       |
| population  | integer  | The internal population group the requesting user or fingerprint is in |
| hash_result | ?integer | The calculated [rollout position](#rollout-positions) to use           |

### Guild Experiments

The data provided here is more detailed, because the client has to figure out itself the assigned bucket for each guild. It may
seem daunting to parse this given the sheer amount of arrays/lists, but it's really quite simple.

###### Guild Experiment Structure

| Field               | Type                                                                    | Description                                                                                                                           |
| ------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| hash                | integer                                                                 | 32-bit unsigned Murmur3 hash of the experiment's name                                                                                 |
| hash_key            | ?string                                                                 | The human-readable experiment name (formatted as `year-month_name`) to use for hashing calculations; prioritized over the client name |
| revision            | integer                                                                 | Current version of the rollout                                                                                                        |
| populations         | array[[experiment population](#experiment-population-object)]           | The experiment rollout's populations                                                                                                  |
| overrides           | array[[experiment bucket override](#experiment-bucket-override-object)] | Bucket overrides for this experiment                                                                                                  |
| overrides_formatted | array[array[[experiment population](#experiment-population-object)]]    | Additional rollout populations, the top-level array has only one item                                                                 |

###### Example Guild Experiment

```json
[
  1405831955,
  "2021-06_guild_role_subscriptions",
  0,
  [
    [
      [
        [
          -1,
          [
            {
              "s": 7200,
              "e": 10000
            }
          ]
        ],
        [
          1,
          [
            {
              "s": 0,
              "e": 7200
            }
          ]
        ]
      ],
      [
        [
          2294888943,
          [
            [2690752156, 1405831955],
            [1982804121, 10000]
          ]
        ]
      ]
    ]
  ],
  [],
  [
    [
      [
        [
          [
            1,
            [
              {
                "s": 0,
                "e": 10000
              }
            ]
          ]
        ],
        [[1604612045, [[1183251248, ["GUILD_ROLE_SUBSCRIPTIONS"]]]]]
      ]
    ]
  ]
]
```

### Experiment Population Object

The population object defines a set of filters and position ranges required to meet specific buckets.

###### Experiment Population Structure

| Field   | Type                                                                        | Description                                                                      |
| ------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| ranges  | array[[experiment population range](#experiment-population-range-object)]   | The ranges for this population                                                   |
| filters | array[[experiment population filter](#experiment-population-filter-object)] | The filters that the resource must satisfy before being eligible for this bucket |

###### Example Experiment Population

```json
[
  [
    [
      -1,
      [
        {
          "s": 7200,
          "e": 10000
        }
      ]
    ]
  ],
  [
    [
      2294888943,
      [
        [2690752156, 1405831955],
        [1982804121, 10000]
      ]
    ]
  ]
]
```

### Experiment Population Range Object

These objects are actually represented as a JSON object, unlike most others on this page. This range is comprised of two integers, and
if the filters are satisfied and the range includes the resource's [rollout position](#rollout-positions) then the client assumes the
resource is then eligible for the bucket.

###### Experiment Population Range Structure

| Field   | Type                                                                                    | Description                      |
| ------- | --------------------------------------------------------------------------------------- | -------------------------------- |
| bucket  | integer                                                                                 | The bucket this range applies to |
| rollout | array[[experiment population rollout](#experiment-population-rollout-structure) object] | The range rollout                |

###### Experiment Population Rollout Structure

| Field | Type    | Description             |
| ----- | ------- | ----------------------- |
| s     | integer | The start of this range |
| e     | integer | The end of this range   |

###### Example Experiment Population Range

```json
[
  1,
  [
    {
      "s": 0,
      "e": 4750
    }
  ]
]
```

### Experiment Population Filter Object

This object defines the filters required to be eligible for the ranges.

###### Experiment Population Filter Structure

| Field | Type        | Description                                                                         |
| ----- | ----------- | ----------------------------------------------------------------------------------- |
| type  | integer     | The [type of population filter](#experiment-population-filter-type)                 |
| value | filter data | The [experiment population filter requirements](#experiment-population-filter-type) |

###### Example Experiment Population Filter

```json
[
  2294888943,
  [
    [2690752156, 1405831955],
    [1982804121, 10000]
  ]
]
```

###### Experiment Population Filter Type

| Type       | Name          | Signature                                                     | Description                                                    |
| ---------- | ------------- | ------------------------------------------------------------- | -------------------------------------------------------------- |
| 1604612045 | FEATURE       | [[, array[[guild feature](/resources/guild#guild-features)]]] | The guild features required for eligiblity                     |
| 2404720969 | ID_RANGE      | [[, ?snowflake], [, ?snowflake]]                              | The range of snowflake resource IDs that are eligible          |
| 2918402255 | MEMBER_COUNT  | [[, ?integer], [, ?integer]]                                  | The range of guild member counts that are eligible             |
| 3013771838 | ID_LIST       | [[, array[snowflake]]]                                        | The list of snowflake resource IDs that are eligible           |
| 4148745523 | HUB_TYPE      | [[, array[integer]]]                                          | The [type of hub](#/resources/guild#hub-type) that is eligible |
| 188952590  | VANITY_URL    | [[, boolean]]                                                 | Whether a vanity is or is not required for eligibility         |
| 2294888943 | RANGE_BY_HASH | [[, integer], [, integer]]                                    | Unknown                                                        |

### Experiment Bucket Override Object

An override represents a manual setting by Discord staff to grant a resource early or specific access to an experiment. Contrary to what you'd
expect, guild experiments can be and are often overriden and assigned to a user ID.

###### Experiment Bucket Override Structure

| Field | Type             | Description                             |
| ----- | ---------------- | --------------------------------------- |
| b     | integer          | Bucket assigned to these resources      |
| k     | array[snowflake] | Resources granted access to this bucket |

###### Experiment Bucket Override Example

```json
{
  "b": 1,
  "k": ["882680660588904448", "882703776794959873", "859533785225494528", "859533828754505741"]
}
```

## Endpoints

<RouteHeader method="GET" url="/experiments">
  Get Experiment Assignments
</RouteHeader>

Returns the [user experiment assignments](#user-experiments) and optionally [guild experiment rollouts](#guild-experiments) for the user/fingerprint.

<Alert type="info">

A fingerprint will only be generated and returned if no authorization or fingerprint is provided in request headers. Fingerprint generation has a rate limit of 3 valid fingerprints per 2 minutes per IP. While fingerprints will still be returned past this rate limit, they will not be usable.

</Alert>

###### Query String Parameters

| Field                   | Type    | Description                                               |
| ----------------------- | ------- | --------------------------------------------------------- |
| with_guild_experiments? | boolean | Whether to include guild experiments in the returned data |

###### Response Structure

| Field              | Type                                              | Description                                                           |
| ------------------ | ------------------------------------------------- | --------------------------------------------------------------------- |
| fingerprint?       | string                                            | A generated [fingerprint](#fingerprints) of the current date and time |
| assignments        | array[[experiment assignment](#user-experiments)] | The experiment assignments for this user or fingerprint               |
| guild_experiments? | array[[guild experiment](#guild-experiments)]     | Guild experiment rollouts for the client to assign                    |
