# Experiments

Experiments are a form of A/B testing used by Discord in the client- and server-side of their applications to serve
different experiences or behaviours to different users randomly and/or based on location, client version, etc.

At their core, rollouts are simply YAML inputted into the Discord admin panel; however, not all of the data
is required by clients. Therefore, the actual experiments clients see are minified and complex to decipher.

## Fingerprints

Even the marketing website uses A/B tests to hook users into the app. Therefore, the app needs a unique way to identify the
person using the website without using authentication (for users initially visiting the landing page), so it resorts to using
"fingerprints".

These aren't the usual fingerprints generated by collecting information about the browser; instead, they are snowflakes generated
by unauthenticated requests to [Get Experiment Assignments](#get-experiment-assignments). It is expected that fingerprints are sent
in the `X-Fingerprint` header in all subsequent requests to the API until authentication, in order to track A/B tests and allow
access to API-locked portions of experiments.

A fingerprint is comprised of a snowflake and a hashed cryptographic value. It looks like this: `1084179945133187083.JQddgNMmwJPghoBtFmaH7jTmdsw`.

When registering a new account, the fingerprint is passed, and (if valid) is used as the created user's ID. This is done in order
to preserve experiments across to the registered user. Therefore, a user account's creation time theoretically represents the first
time they visited Discord's marketing website.

## Rollouts

Experiment rollouts are defined in _populations_ based on the user or guild's [rollout position](#rollout-positions)
and can have _filters_ to narrow each population's availability.

###### Example Rollout

```md
2023-02_stage_boosting (1816004721)

### Treatment 1

Filters

Guild Features: [COMMUNITY]
Member Count Range: 1000 - null
Hash Range: Hash Key: 1816004721, Target: 10000

Position Ranges

5000-9500, 9500-10000

### Control

Filters

Guild Features: [COMMUNITY]
Member Count Range: 1000 - null

Position Ranges

0 - 10000

### None

Position Ranges

0 - 10000
```

### Treatments

`Control` and `None` are represented in the API as the integer values `0` and `-1`, respectively. Just as a warning, there are some instances of experiments having specific unnecessary treatments
labelled as `Control` indexed as `1`.

### Rollout Positions

A rollout position is calculated using the following pseudo code, where `exp_name` is the human readable name for the experiment and `resource_id` is the user, fingerprint or guild's ID.
This position is used in conjunction with the rollout populations and filters to figure out what the assigned bucket for the experiments are by simply checking which treatment the population is included in[.](https://gist.github.com/c3f521becd84b923c2778546c79a7a03)

```py
result = mmh3.hash('exp_name:resource_id', signed=False) % 10000
```

## Data Structures

There are two types of experiments, user experiments and guild experiments. Metadata and human-readable experiment names
are available in the user-facing clients. However, API objects do not contain such data, except for guild experiments which may have a human-readable name provided for hash calculations, overriding the one in clients.

Most of the below objects are represented as arrays following the order the fields are documented in.

### User Experiments

User experiment data returned by the API is very limited. In contrast to the wide range of data the API provides for
guild rollouts, the only values we can programmatically retrieve from the API are the user/[fingerprint](#fingerprints)'s assigned
bucket for the experiment.

###### User Experiment Structure

This object is represented as an array of the following fields:

| Field       | Type    | Description                                                                                       |
| ----------- | ------- | ------------------------------------------------------------------------------------------------- |
| hash        | integer | 32-bit unsigned Murmur3 hash of the experiment's name                                             |
| revision    | integer | Current version of the rollout                                                                    |
| bucket      | integer | The requesting user or fingerprint's assigned experiment bucket                                   |
| override    | integer | Overriden bucket for the user, holds more priority than `bucket`                                  |
| population  | integer | The internal population group the requesting user or fingerprint is in                            |
| hash_result | integer | The calculated [rollout position](#rollout-positions) to use; prioritized over local calculations |
| aa_mode ^1^ | integer | The experiment's A/A testing mode, represented as an integer-casted boolean                       |

^1^ The bucket for A/A tested experiments should always be None (`-1`).

###### Example User Experiment

```json
[4130837190, 0, 10, -1, 0, 1932, 0]
```

### Guild Experiments

The data provided here is more detailed, because the client has to figure out itself the assigned bucket for each guild. It may
seem daunting to parse this given the sheer amount of arrays, but it's really quite simple.

###### Guild Experiment Structure

This object is represented as an array of the following fields:

| Field               | Type                                                                    | Description                                                                                                                           |
| ------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| hash                | integer                                                                 | 32-bit unsigned Murmur3 hash of the experiment's name                                                                                 |
| hash_key            | ?string                                                                 | The human-readable experiment name (formatted as `year-month_name`) to use for hashing calculations; prioritized over the client name |
| revision            | integer                                                                 | Current version of the rollout                                                                                                        |
| populations         | array[[experiment population](#experiment-population-object)]           | The experiment rollout's populations                                                                                                  |
| overrides           | array[[experiment bucket override](#experiment-bucket-override-object)] | Bucket overrides for this experiment                                                                                                  |
| overrides_formatted | array[array[[experiment population](#experiment-population-object)]]    | Additional rollout populations, the top-level array has only one item                                                                 |
| holdout_name ^1^    | ?string                                                                 | The human-readable experiment name (formatted as `year-month_name`) that this experiment is dependent on                              |
| holdout_bucket ^1^  | ?integer                                                                | The required bucket for the experiment this experiment is dependent on                                                                |
| aa_mode ^2^         | integer                                                                 | The experiment's A/A testing mode, represented as an integer-casted boolean                                                           |

^1^ Failure to meet the holdout experiment's requirements will result in a bucket of None (`-1`).

^2^ The bucket for A/A tested experiments should always be None (`-1`).

###### Example Guild Experiment

```json
[
  1405831955,
  "2021-06_guild_role_subscriptions",
  0,
  [
    [
      [
        [
          -1,
          [
            {
              "s": 7200,
              "e": 10000
            }
          ]
        ],
        [
          1,
          [
            {
              "s": 0,
              "e": 7200
            }
          ]
        ]
      ],
      [
        [
          2294888943,
          [
            [2690752156, 1405831955],
            [1982804121, 10000]
          ]
        ]
      ]
    ]
  ],
  [],
  [
    [
      [
        [
          [
            1,
            [
              {
                "s": 0,
                "e": 10000
              }
            ]
          ]
        ],
        [[1604612045, [[1183251248, ["GUILD_ROLE_SUBSCRIPTIONS"]]]]]
      ]
    ]
  ],
  null,
  null,
  0
]
```

### Experiment Population Object

The population object defines a set of filters and position ranges required to meet specific buckets.

###### Experiment Population Structure

This object is represented as an array of the following fields:

| Field   | Type                                                                             | Description                                                         |
| ------- | -------------------------------------------------------------------------------- | ------------------------------------------------------------------- |
| ranges  | array[[experiment population range](#experiment-population-range-object) object] | The ranges for this population                                      |
| filters | [experiment population filters](#experiment-population-filters-object) object    | The filters that the resource must satisfy to be in this population |

###### Example Experiment Population

```json
[
  [
    [
      -1,
      [
        {
          "s": 7200,
          "e": 10000
        }
      ]
    ]
  ],
  [
    [
      2294888943,
      [
        [2690752156, 1405831955],
        [1982804121, 10000]
      ]
    ]
  ]
]
```

### Experiment Population Range Object

If the filters in a given population are satisfied and a range includes the resource's [rollout position](#rollout-positions), the resource is then eligible for the given bucket.

###### Experiment Population Range Structure

This object is represented as an array of the following fields:

| Field   | Type                                                                                    | Description                  |
| ------- | --------------------------------------------------------------------------------------- | ---------------------------- |
| bucket  | integer                                                                                 | The bucket this range grants |
| rollout | array[[experiment population rollout](#experiment-population-rollout-structure) object] | The range rollout            |

###### Experiment Population Rollout Structure

| Field | Type    | Description             |
| ----- | ------- | ----------------------- |
| s     | integer | The start of this range |
| e     | integer | The end of this range   |

###### Example Experiment Population Range

```json
[
  1,
  [
    {
      "s": 0,
      "e": 4750
    }
  ]
]
```

### Experiment Population Filters Object

This object defines the filters required to be eligible for the ranges. All provided filters must be satisfied for the resource to be eligible for the given bucket.

The filters are an object represented as an array of arrays. The first item in the nested array is a 32-bit unsigned Murmur3 hashed representation of the key, and the second item is the value, with the value being another array-represented object. All structures below are represented in this way.

<Alert type="info">

The field order for filter structures (other than the top-level structure below) is guaranteed to be in the same order as documented.

</Alert>

###### Experiment Population Filters Structure

| Field                     | Type                                                                                                       | Description                                                             |
| ------------------------- | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- |
| guild_has_feature?        | [experiment population guild feature filter](#experiment-population-guild-feature-filter-structure) object | The [guild features](/resources/guild#guild-features) that are eligible |
| guild_id_range?           | [experiment population range filter](#experiment-population-range-filter-structure) object                 | The range of snowflake resource IDs that are eligible                   |
| guild_age_range_days? ^1^ | [experiment population range filter](#experiment-population-range-filter-structure) object                 | The range of guild ages (in days) that are eligible                     |
| guild_member_count_range? | [experiment population range filter](#experiment-population-range-filter-structure) object                 | The range of guild member counts that are eligible                      |
| guild_ids?                | [experiment population ID filter](#experiment-population-id-filter-structure) object                       | A list of resource IDs that are eligible                                |
| guild_hub_types?          | [experiment population hub type filter](#experiment-population-hub-type-filter-structure) object           | A list of [hub types](/resources/guild#hub-type) that are eligible      |
| guild_has_vanity_url?     | [experiment population vanity URL filter](#experiment-population-vanity-url-filter-structure) object       | Whether a vanity is or is not required to be eligible                   |
| guild_in_range_by_hash?   | [experiment population range by hash filter](#experiment-population-range-by-hash-filter-structure) object | The special rollout position limits on the population                   |

^1^ The guild age is determined from the guild's ID. See the [snowflake documentation](/reference#snowflake-format) for more information.
The age can be calculated using the following pseudocode, where `resource_id` is the guild's ID:

```py
timestamp = ((resource_id >> 22) + 1420070400000) / 1000
guild_age = (time.time() - timestamp) / 86400
```

###### Experiment Population Guild Feature Filter Structure

| Field          | Type          | Description                                                                                                                      |
| -------------- | ------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| guild_features | array[string] | The [guild features](/resources/guild#guild-features) eligible for this population; only one feature is required for eligibility |

###### Experiment Population Range Filter Structure

| Field  | Type       | Description                                  |
| ------ | ---------- | -------------------------------------------- |
| min_id | ?snowflake | The exclusive minimum for this range, if any |
| max_id | ?snowflake | The exclusive maximum for this range, if any |

###### Experiment Population ID Filter Structure

| Field     | Type             | Description                                                              |
| --------- | ---------------- | ------------------------------------------------------------------------ |
| guild_ids | array[snowflake] | The list of snowflake resource IDs that are eligible for this population |

###### Experiment Population Hub Type Filter Structure

| Field           | Type           | Description                                                                         |
| --------------- | -------------- | ----------------------------------------------------------------------------------- |
| guild_hub_types | array[integer] | The [type of hubs](/resources/guild#hub-type) that are eligible for this population |

###### Experiment Population Vanity URL Filter Structure

| Field                | Type    | Description                                                |
| -------------------- | ------- | ---------------------------------------------------------- |
| guild_has_vanity_url | boolean | The required vanity URL holding status for this population |

###### Experiment Population Range By Hash Filter Structure

<Alert type="info">

This filter is used to limit rollout position by an additional hash key. The calculated rollout position must be less than the given target. The rollout position can be calculated using the following pseudocode, where `hash_key` is the provided hash key and `resource_id` is the guild ID:

```py
hashed = mmh3.hash('hash_key:resource_id', signed=False)
if hashed > 0:
    # Double the hash
    hashed += hashed
else:
    # Unsigned right shift by 0
    hashed = (hashed % 0x100000000) >> 0
result = hashed % 10000
```

</Alert>

| Field    | Type    | Description                                                               |
| -------- | ------- | ------------------------------------------------------------------------- |
| hash_key | integer | The 32-bit unsigned Murmur3 hash of the key used to determine eligibility |
| target   | integer | The rollout position limit for this population                            |

###### Example Experiment Population Filters

```json
[
  [
    1604612045, // guild_has_feature
    [
      [
        1183251248, // guild_features
        ["ROLE_SUBSCRIPTIONS_ENABLED"]
      ]
    ]
  ]
]
```

### Experiment Bucket Override Object

An override represents a manual setting by Discord employees to grant a resource early or specific access to an experiment. Contrary to what you'd
expect, guild experiments can be and are often overriden and assigned to a user ID.

###### Experiment Bucket Override Structure

| Field | Type             | Description                             |
| ----- | ---------------- | --------------------------------------- |
| b     | integer          | Bucket assigned to these resources      |
| k     | array[snowflake] | Resources granted access to this bucket |

###### Experiment Bucket Override Example

```json
{
  "b": 1,
  "k": ["882680660588904448", "882703776794959873", "859533785225494528", "859533828754505741"]
}
```

## Endpoints

<RouteHeader method="GET" url="/experiments">
  Get Experiment Assignments
</RouteHeader>

Returns the [user experiment assignments](#user-experiments) and optionally [guild experiment rollouts](#guild-experiments) for the user/fingerprint.

<Alert type="info">

Returned experiments are dependent on the requesting [client properties](/reference#client-properties).

</Alert>

<Alert type="warn">

A fingerprint will only be generated and returned if no authorization or fingerprint is provided in request headers. Fingerprint generation has a rate limit of 3 valid fingerprints per 2 minutes per IP. While fingerprints will still be returned past this rate limit, they will not be valid.

</Alert>

###### Query String Parameters

| Field                   | Type    | Description                                               |
| ----------------------- | ------- | --------------------------------------------------------- |
| with_guild_experiments? | boolean | Whether to include guild experiments in the returned data |

###### Response Body

| Field              | Type                                              | Description                                                           |
| ------------------ | ------------------------------------------------- | --------------------------------------------------------------------- |
| fingerprint?       | string                                            | A generated [fingerprint](#fingerprints) of the current date and time |
| assignments        | array[[experiment assignment](#user-experiments)] | The experiment assignments for this user or fingerprint               |
| guild_experiments? | array[[guild experiment](#guild-experiments)]     | Guild experiment rollouts for the client to assign                    |

<RouteHeader method="POST" url="/auth/fingerprint" deprecated>
  Create Fingerprint
</RouteHeader>

Generates a new [fingerprint](#fingerprints).

<Alert type="warn">

Fingerprint generation has a rate limit of 3 valid fingerprints per 2 minutes per IP. While fingerprints will still be returned past this rate limit, they will not be valid.

</Alert>

###### Response Body

| Field       | Type   | Description                                            |
| ----------- | ------ | ------------------------------------------------------ |
| fingerprint | string | The generated fingerprint of the current date and time |
